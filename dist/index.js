"use strict";var $=Object.create;var P=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var p=(t,e)=>P(t,"name",{value:e,configurable:!0});var G=(t,e,o,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of V(e))!B.call(t,a)&&a!==o&&P(t,a,{get:()=>e[a],enumerable:!(s=q(e,a))||s.enumerable});return t};var m=(t,e,o)=>(o=t!=null?$(D(t)):{},G(e||!t||!t.__esModule?P(o,"default",{value:t,enumerable:!0}):o,t));var v=m(require("fastify")),F=m(require("@fastify/helmet")),L=m(require("@fastify/compress")),U=m(require("@fastify/cors")),j=require("fs"),M=m(require("path")),b=m(require("cross-fetch")),x=require("@ethereumjs/tx"),Y=require("@theconvospace/sdk"),R=require("@ethersproject/address");var y=m(require("path")),w=m(require("util")),S=require("fs/promises"),_=require("fs"),I=require("@ethersproject/address"),k=m(require("cross-fetch"));require("dotenv").config({path:".env"});var r=p(t=>{let e=process.env[t];if(e===void 0)throw new Error(`'${t}' Environment Variable is Not Defined`);return e},"getEnv");var N=w.default.promisify(require("child_process").exec),E=new Map;E.set("mainnet",`https://api.etherscan.io/api?apikey=${r("ETHERSCAN_API_KEY")}`);E.set("polygon",`https://api.polygonscan.com/api?apikey=${r("POLYGONSCAN_API_KEY")}`);E.set("polygon-testnet",`https://api-testnet.polygonscan.com/api?apikey=${r("POLYGONSCAN_API_KEY")}`);async function J(t,e,o){var d;let s=y.default.join(__dirname,"../contracts");(0,_.existsSync)(s)||(0,_.mkdirSync)(s);let a=t+"-"+(0,I.getAddress)(e);await(0,S.writeFile)(y.default.join(s,a+".sol"),o);let n=`slither ${y.default.join(s,a+".sol")} --json ${y.default.join(s,a+".json")} --exclude-low --exclude-medium --exclude-informational --exclude-optimization --solc-disable-warnings`;try{let{stdout:l,stderr:c}=await N(n)}catch{}let i=await(0,S.readFile)(y.default.join(s,a+".json"),{encoding:"utf8"}),g=JSON.parse(i.toString());return g.success===!0&&((d=g.results)==null?void 0:d.detectors)!=null&&g.results.detectors.length>0?(console.log("storeAndRun/foundIssue"),{foundIssue:!0,data:g.results.detectors}):(console.log("storeAndRun/Nothing Found"),{foundIssue:!1,data:[]})}p(J,"storeAndRun");async function H(t){let{stderr:e}=await N(`solc-select use ${t}`);return e===""?!0:(console.error(e),!1)}p(H,"setSolidityVersion");async function C(t,e){var a;let o=t+"-"+(0,I.getAddress)(e),s=y.default.join(__dirname,"../contracts",o+".json");if((0,_.existsSync)(s)){let n=await(0,S.readFile)(s,{encoding:"utf8"}),i=JSON.parse(n.toString());return i.success===!0&&((a=i.results)==null?void 0:a.detectors)!=null&&i.results.detectors.length>0?{cached:!0,success:!0,results:i.results.detectors,error:""}:{cached:!0,success:!0,results:[],error:""}}else{let n=await(0,k.default)(`${E.get(t)}&module=contract&action=getsourcecode&address=${e}`);if(n.ok===!0){let i=await n.json();if(i.status=="1"&&i.result.length>0)if(i.result[0].Proxy==="0"){let g=i.result[0].SourceCode,d=i.result[0].CompilerVersion.split("+")[0].slice(1),l=await H(d);if(console.log("setVersionResp",d,l),l===!0){let c=await J(t,e,g);return c.foundIssue?{success:!0,results:c.data,error:""}:{success:!0,results:[],error:""}}else return console.log("Failed to set Solidity Version."),{success:!1,error:"Failed to set Solidity Version.",results:[]}}else return{success:!1,error:"Proxy",results:[]};else return console.log("Source code not verified on EtherScan"),{success:!1,error:"Source code not verified on EtherScan",results:[]}}else return console.log("Error Fetching Source Code from EtherScan"),{success:!1,error:"Error Fetching Source Code from EtherScan",results:[]}}}p(C,"testUsingSlither");var h=(0,v.default)({logger:!1}),z=require("ethereumjs-util").toBuffer,Q=require("eth-phishing-detect");h.register(F.default,{global:!0});h.register(L.default,{global:!0});h.register(U.default,{origin:"*"});var W=`https://api.tenderly.co/api/v1/account/${r("TENDERLY_USER")}/project/${r("TENDERLY_PROJECT")}/simulate`,X=new Y.Convo(r("CONVO_API_KEY")),Z={alchemyApiKey:r("ALCHEMY_API_KEY"),CNVSEC_ID:r("CNVSEC_ID"),etherscanApiKey:r("ETHERSCAN_API_KEY"),polygonscanApiKey:r("POLYGONSCAN_API_KEY"),optimismscanApiKey:r("OPTIMISMSCAN_API_KEY"),polygonMainnetRpc:"",etherumMainnetRpc:"",avalancheMainnetRpc:"",maticPriceInUsd:0,etherumPriceInUsd:0,deepdaoApiKey:"",zapperApiKey:"",DEBUG:!1},A={mainnet:r("MAINNET_RPC_URL"),"mainnet-flashbots":r("MAINNET_FLASHBOTS_RPC_URL"),"mainnet-flashbots-fast":r("MAINNET_FLASHBOTS_FAST_RPC_URL"),ropsten:r("ROPSTEN_RPC_URL"),kovan:r("KOVAN_RPC_URL"),rinkeby:r("RINKEBY_RPC_URL"),goerli:r("GOERLI_RPC_URL"),sepolia:r("SEPOLIA_RPC_URL"),"goerli-flashbots":r("GOERLI_FLASHBOTS_RPC_URL"),polygon:r("POLYGON_RPC_URL"),"polygon-testnet":r("POLYGON_TESTNET_RPC_URL"),optimism:r("OPTIMISM_RPC_URL"),"optimism-testnet":r("OPTIMISM_TESTNET_RPC_URL"),arbitrum:r("ARBITRUM_RPC_URL"),"arbitrum-testnet":r("ARBITRUM_TESTNET_RPC_URL"),manual:"1"};Object.freeze(A);function u(t){return{isMalicious:!0,rpcResp:{id:420,jsonrpc:"2.0",error:{code:-32003,message:t}}}}p(u,"getMalRpcError");async function O(t){try{if((0,R.isAddress)(t)){let e=await X.omnid.kits.isMalicious((0,R.getAddress)(t),Z);return console.log("omnid.kits.isMalicious",(0,R.getAddress)(t),e),(e==null?void 0:e.alchemy)&&e.alchemy===!0?u("Spam Contract Flagged by Alchemy"):(e==null?void 0:e.chainabuse)&&e.chainabuse===!0?u("Contract Flagged by ChainAbuse"):(e==null?void 0:e.cryptoscamdb)&&e.cryptoscamdb===!0?u("Contract Flagged by CryptoscamDB"):(e==null?void 0:e.etherscan)&&"label"in e.etherscan?u(`Address Flagged as ${e.etherscan.label} by Etherscan`):(e==null?void 0:e.mew)&&"comment"in e.mew?u("Address Flagged by MyEtherWallet"):e!=null&&e.sdn?u("Address Flagged by OFAC"):e!=null&&e.tokenblacklist?u("Address Blacklisted by Stablecoin"):e!=null&&e.txn?u("Address/Contract Funded by Tornado Cash."):{isMalicious:!1}}else return{isMalicious:!1}}catch{return{isMalicious:!1}}}p(O,"checkAddress");async function ee(t){try{return await(0,b.default)(W,{method:"POST",body:JSON.stringify(t),headers:{"X-Access-Key":r("TENDERLY_ACCESS_KEY")}}).then(o=>o.json())}catch(e){return console.log("alchemySimulate",e),!1}}p(ee,"alchemySimulate");async function K(t,e){let o=e.query;try{let s=t==="manual"?o.rpcUrl:A[t];if(s!==void 0)return await(0,b.default)(s,{method:"POST",body:JSON.stringify(e.body),headers:{"Content-Type":"application/json",Accept:"application/json","infura-source":"metamask/internal",origin:"chrome-extension://nkbihfbeogaeaoehlefnkodbefgpgknn"}}).then(n=>n.json());{let{rpcResp:a}=u("Invalid RPC Url");return a}}catch(s){let{rpcResp:a}=u(s);return a}}p(K,"sendToRpc");async function te(t,e){let o=e.body,s=e.query;var a=z(o.params[0]),n=x.FeeMarketEIP1559Transaction.fromSerializedTx(a),i=n.toJSON();if(Object.keys(i).includes("to")===!0){let{isMalicious:l,rpcResp:c}=await O(i.to);if(l==!0&&c)return c.id=o.id,c}let g={network_id:parseInt(n.chainId.toString(10)),from:n.getSenderAddress().toString(),to:n.to?n.to.toString():"",input:n.data.toString("hex"),gas:parseInt(n.gasLimit.toString(10)),gas_price:n.maxFeePerGas.add(n.maxPriorityFeePerGas).toString(10),value:parseInt(n.value.toString(10)),save_if_fails:!0,save:!1,simulation_type:"full"},d=await ee(g);if(d!=null&&d!=!1&&"transaction_info"in d&&d.transaction_info!=null){console.log("Sim Successful");for(let l=0;l<d.transaction_info.logs.length;l++){let c=d.transaction_info.logs[l];if(c.name==="Approval"||c.name==="Transfer"){let{isMalicious:f,rpcResp:T}=await O(c.inputs[1].value);if(f===!0)return T}}}if(t!="manual"&&"blockUnverifiedContracts"in s&&s.blockUnverifiedContracts===!0){let l=await(0,b.default)(`https://sourcify.dev/server/check-all-by-addresses?addresses=${i==null?void 0:i.to}&chainIds=1,4,11155111,137,80001,10,42161,421611`),c;if(l.ok===!0){if(c=await l.json(),Object.keys(c).includes("status")){let{rpcResp:f}=u("The contract is unverified");return f}}else{let{rpcResp:f}=u("Sourcify Request Failed");return f}}if(t in["mainnet","polygon","polygon-testnet"]&&(s==null?void 0:s.enableScanners)!==void 0&&i.to!==void 0){let l=t,c=s.enableScanners.split(",");for(let f=0;f<c.length;f++)if(c[f]in["slither"]&&(await C(l,i.to)).results.length>0)return await u("Slither detected possible attack vectors")}return await K(t,e)}p(te,"processTxs");h.get("/",async(t,e)=>{let o=await(0,j.readFileSync)(M.default.join(__dirname,"../public/","index.html"));e.header("Content-Security-Policy","default-src *; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; img-src data:;"),e.type("text/html").send(o)});h.post("/lifejacket/slither",async(t,e)=>{let{network:o,address:s}=t.body;if(o!=null&&s!=null&&(0,R.isAddress)(s)){let a=await C(o,s);return e.send(a)}else return e.send({success:!1,error:"Invalid body params, network or address"})});h.post("/:network",async(t,e)=>{let{hostname:o}=t,s=t.body;if(Q(o)){let{rpcResp:n}=u(`\u{1F6A8} Phishing detector for the site ${o} has been triggered.`);e.send(n)}else{let{network:n}=t.params;if(n&&Object.keys(A).includes(n)===!0)if(s.method=="eth_sendRawTransaction"){let i=await te(n,t);e.send(i)}else{let i=await K(n,t);e.send(i)}else e.send({error:`Invalid network '${n}', available networks are ${Object.keys(A).join(", ")}`})}});h.listen({port:parseInt(r("PORT"))||8545,host:"0.0.0.0"},(t,e)=>{if(!t)console.log("\u{1F680} Server is listening on",e);else throw t});
