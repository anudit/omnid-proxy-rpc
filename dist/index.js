"use strict";var K=Object.create;var b=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var p=(t,e)=>b(t,"name",{value:e,configurable:!0});var G=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of V(e))!B.call(t,i)&&i!==n&&b(t,i,{get:()=>e[i],enumerable:!(o=$(e,i))||o.enumerable});return t};var f=(t,e,n)=>(n=t!=null?K(D(t)):{},G(e||!t||!t.__esModule?b(n,"default",{value:t,enumerable:!0}):n,t));var O=f(require("fastify")),v=f(require("@fastify/helmet")),F=f(require("@fastify/compress")),L=f(require("@fastify/cors")),U=require("fs"),j=f(require("path")),P=f(require("cross-fetch")),M=require("@ethereumjs/tx"),x=require("@theconvospace/sdk"),R=require("@ethersproject/address");var y=f(require("path")),C=f(require("util")),S=require("fs/promises"),_=require("fs"),I=require("@ethersproject/address"),T=f(require("cross-fetch"));require("dotenv").config({path:".env"});var s=p(t=>{let e=process.env[t];if(e===void 0)throw new Error(`'${t}' Environment Variable is Not Defined`);return e},"getEnv");var w=C.default.promisify(require("child_process").exec),E=new Map;E.set("mainnet",`https://api.etherscan.io/api?apikey=${s("ETHERSCAN_API_KEY")}`);E.set("polygon",`https://api.polygonscan.com/api?apikey=${s("POLYGONSCAN_API_KEY")}`);E.set("polygon-testnet",`https://api-testnet.polygonscan.com/api?apikey=${s("POLYGONSCAN_API_KEY")}`);async function J(t,e,n){var d;let o=y.default.join(__dirname,"../contracts");(0,_.existsSync)(o)||(0,_.mkdirSync)(o);let i=t+"-"+(0,I.getAddress)(e);await(0,S.writeFile)(y.default.join(o,i+".sol"),n);let r=`slither ${y.default.join(o,i+".sol")} --json ${y.default.join(o,i+".json")} --exclude-low --exclude-medium --exclude-informational --exclude-optimization --solc-disable-warnings`;try{let{stdout:l,stderr:c}=await w(r)}catch{}let a=await(0,S.readFile)(y.default.join(o,i+".json"),{encoding:"utf8"}),m=JSON.parse(a.toString());return m.success===!0&&((d=m.results)==null?void 0:d.detectors)!=null&&m.results.detectors.length>0?(console.log("storeAndRun/foundIssue"),{foundIssue:!0,data:m.results.detectors}):(console.log("storeAndRun/Nothing Found"),{foundIssue:!1,data:[]})}p(J,"storeAndRun");async function H(t){let{stderr:e}=await w(`solc-select use ${t}`);return e===""?!0:(console.error(e),!1)}p(H,"setSolidityVersion");async function N(t,e){var i;let n=t+"-"+(0,I.getAddress)(e),o=y.default.join(__dirname,"../contracts",n+".json");if((0,_.existsSync)(o)){let r=await(0,S.readFile)(o,{encoding:"utf8"}),a=JSON.parse(r.toString());return a.success===!0&&((i=a.results)==null?void 0:i.detectors)!=null&&a.results.detectors.length>0?{cached:!0,success:!0,results:a.results.detectors,error:""}:{cached:!0,success:!0,results:[],error:""}}else{let r=await(0,T.default)(`${E.get(t)}&module=contract&action=getsourcecode&address=${e}`);if(r.ok===!0){let a=await r.json();if(a.status=="1"&&a.result.length>0)if(a.result[0].Proxy==="0"){let m=a.result[0].SourceCode,d=a.result[0].CompilerVersion.split("+")[0].slice(1),l=await H(d);if(console.log("setVersionResp",d,l),l===!0){let c=await J(t,e,m);return c.foundIssue?{success:!0,results:c.data,error:""}:{success:!0,results:[],error:""}}else return console.log("Failed to set Solidity Version."),{success:!1,error:"Failed to set Solidity Version.",results:[]}}else return{success:!1,error:"Proxy",results:[]};else return console.log("Source code not verified on EtherScan"),{success:!1,error:"Source code not verified on EtherScan",results:[]}}else return console.log("Error Fetching Source Code from EtherScan"),{success:!1,error:"Error Fetching Source Code from EtherScan",results:[]}}}p(N,"testUsingSlither");require("dotenv").config({path:".env"});var g=(0,O.default)({logger:!1}),z=require("ethereumjs-util").toBuffer,Q=require("eth-phishing-detect");g.register(v.default,{global:!0});g.register(F.default,{global:!0});g.register(L.default,{origin:"*"});var W=`https://api.tenderly.co/api/v1/account/${s("TENDERLY_USER")}/project/${s("TENDERLY_PROJECT")}/simulate`,X=new x.Convo(s("CONVO_API_KEY")),Z={alchemyApiKey:s("ALCHEMY_API_KEY"),CNVSEC_ID:s("CNVSEC_ID"),etherscanApiKey:s("ETHERSCAN_API_KEY"),polygonscanApiKey:s("POLYGONSCAN_API_KEY"),optimismscanApiKey:s("OPTIMISMSCAN_API_KEY"),polygonMainnetRpc:"",etherumMainnetRpc:"",avalancheMainnetRpc:"",maticPriceInUsd:0,etherumPriceInUsd:0,deepdaoApiKey:"",zapperApiKey:"",DEBUG:!1},A={mainnet:s("MAINNET_RPC_URL"),"mainnet-flashbots":s("MAINNET_FLASHBOTS_RPC_URL"),"mainnet-flashbots-fast":s("MAINNET_FLASHBOTS_FAST_RPC_URL"),ropsten:s("ROPSTEN_RPC_URL"),kovan:s("KOVAN_RPC_URL"),rinkeby:s("RINKEBY_RPC_URL"),goerli:s("GOERLI_RPC_URL"),sepolia:s("SEPOLIA_RPC_URL"),"goerli-flashbots":s("GOERLI_FLASHBOTS_RPC_URL"),polygon:s("POLYGON_RPC_URL"),"polygon-testnet":s("POLYGON_TESTNET_RPC_URL"),optimism:s("OPTIMISM_RPC_URL"),"optimism-testnet":s("OPTIMISM_TESTNET_RPC_URL"),arbitrum:s("ARBITRUM_RPC_URL"),"arbitrum-testnet":s("ARBITRUM_TESTNET_RPC_URL"),manual:"1"};Object.freeze(A);function u(t){return{isMalicious:!0,rpcResp:{id:420,jsonrpc:"2.0",error:{code:-32003,message:t}}}}p(u,"getMalRpcError");async function k(t){try{if((0,R.isAddress)(t)){let e=await X.omnid.kits.isMalicious((0,R.getAddress)(t),Z);return console.log("omnid.kits.isMalicious",(0,R.getAddress)(t),e),(e==null?void 0:e.alchemy)&&e.alchemy===!0?u("Spam Contract Flagged by Alchemy"):(e==null?void 0:e.chainabuse)&&e.chainabuse===!0?u("Contract Flagged by ChainAbuse"):(e==null?void 0:e.cryptoscamdb)&&e.cryptoscamdb===!0?u("Contract Flagged by CryptoscamDB"):(e==null?void 0:e.etherscan)&&"label"in e.etherscan?u(`Address Flagged as ${e.etherscan.label} by Etherscan`):(e==null?void 0:e.mew)&&"comment"in e.mew?u("Address Flagged by MyEtherWallet"):e!=null&&e.sdn?u("Address Flagged by OFAC"):e!=null&&e.tokenblacklist?u("Address Blacklisted by Stablecoin"):e!=null&&e.txn?u("Address/Contract Funded by Tornado Cash."):{isMalicious:!1}}else return{isMalicious:!1}}catch{return{isMalicious:!1}}}p(k,"checkAddress");async function ee(t){try{return await(0,P.default)(W,{method:"POST",body:JSON.stringify(t),headers:{"X-Access-Key":s("TENDERLY_ACCESS_KEY")}}).then(n=>n.json())}catch(e){return console.log("alchemySimulate",e),!1}}p(ee,"alchemySimulate");async function Y(t,e){let n=e.query;try{let o=t==="manual"?n.rpcUrl:A[t];if(o!==void 0)return await(0,P.default)(o,{method:"POST",body:JSON.stringify(e.body),headers:{"Content-Type":"application/json",Accept:"application/json","infura-source":"metamask/internal",origin:"chrome-extension://nkbihfbeogaeaoehlefnkodbefgpgknn"}}).then(r=>r.json());{let{rpcResp:i}=u("Invalid RPC Url");return i}}catch(o){let{rpcResp:i}=u(o);return i}}p(Y,"sendToRpc");async function te(t,e){let n=e.body,o=e.query;var i=z(n.params[0]),r=M.FeeMarketEIP1559Transaction.fromSerializedTx(i),a=r.toJSON();if(Object.keys(a).includes("to")===!0){let{isMalicious:l,rpcResp:c}=await k(a.to);if(l==!0&&c)return c.id=n.id,c}let m={network_id:parseInt(r.chainId.toString(10)),from:r.getSenderAddress().toString(),to:r.to?r.to.toString():"",input:r.data.toString("hex"),gas:parseInt(r.gasLimit.toString(10)),gas_price:r.maxFeePerGas.add(r.maxPriorityFeePerGas).toString(10),value:parseInt(r.value.toString(10)),save_if_fails:!0,save:!1,simulation_type:"full"},d=await ee(m);if(d!=null&&d!=!1&&"transaction_info"in d&&d.transaction_info!=null){console.log("Sim Successful");for(let l=0;l<d.transaction_info.logs.length;l++){let c=d.transaction_info.logs[l];if(c.name==="Approval"||c.name==="Transfer"){let{isMalicious:h,rpcResp:q}=await k(c.inputs[1].value);if(h===!0)return q}}}if(t!="manual"&&"blockUnverifiedContracts"in o&&o.blockUnverifiedContracts===!0){let l=await(0,P.default)(`https://sourcify.dev/server/check-all-by-addresses?addresses=${a==null?void 0:a.to}&chainIds=1,4,11155111,137,80001,10,42161,421611`),c;if(l.ok===!0){if(c=await l.json(),Object.keys(c).includes("status")){let{rpcResp:h}=u("The contract is unverified");return h}}else{let{rpcResp:h}=u("Sourcify Request Failed");return h}}return await Y(t,e)}p(te,"processTxs");g.get("/",async(t,e)=>{let n=await(0,U.readFileSync)(j.default.join(__dirname,"../public/","index.html"));e.header("Content-Security-Policy","default-src *; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; img-src data:;"),e.type("text/html").send(n)});g.post("/lifejacket/slither",async(t,e)=>{let{network:n,address:o}=t.body;if(n!=null&&o!=null&&(0,R.isAddress)(o)){let i=await N(n,o);return e.send(i)}else return e.send({success:!1,error:"Invalid body params, network or address"})});g.post("/:network",async(t,e)=>{let{hostname:n}=t,o=t.body;if(Q(n)){let{rpcResp:r}=u(`\u{1F6A8} Phishing detector for the site ${n} has been triggered.`);e.send(r)}else{let{network:r}=t.params;if(r&&Object.keys(A).includes(r)===!0)if(o.method=="eth_sendRawTransaction"){let a=await te(r,t);e.send(a)}else{let a=await Y(r,t);e.send(a)}else e.send({error:`Invalid network '${r}', available networks are ${Object.keys(A).join(", ")}`})}});g.listen({port:parseInt(s("PORT"))||8545,host:"0.0.0.0"},(t,e)=>{if(!t)console.log("\u{1F680} Server is listening on",e);else throw t});
