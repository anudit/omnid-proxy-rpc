"use strict";var Q=Object.create;var N=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var f=(t,e)=>N(t,"name",{value:e,configurable:!0});var te=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of X(e))!ee.call(t,o)&&o!==n&&N(t,o,{get:()=>e[o],enumerable:!(s=W(e,o))||s.enumerable});return t};var m=(t,e,n)=>(n=t!=null?Q(Z(t)):{},te(e||!t||!t.__esModule?N(n,"default",{value:t,enumerable:!0}):n,t));var $=m(require("fastify")),q=m(require("@fastify/helmet")),Y=m(require("@fastify/compress")),K=m(require("@fastify/cors")),D=require("fs"),B=m(require("path")),C=m(require("cross-fetch")),J=require("@ethereumjs/tx"),G=require("@theconvospace/sdk"),S=require("@ethersproject/address");var g=m(require("path")),x=m(require("util")),_=require("fs/promises"),w=require("fs"),j=require("@ethersproject/address"),M=m(require("cross-fetch"));var v=m(require("util"));require("dotenv").config({path:".env"});var i=f(t=>{let e=process.env[t];if(e===void 0)throw new Error(`'${t}' Environment Variable is Not Defined`);return e},"getEnv");var se=v.default.promisify(require("child_process").exec);async function I(t){let{stderr:e}=await se(`solc-select use ${t}`);return e===""?!0:(console.error(e),!1)}f(I,"setSolidityVersion");var b=new Map([["mainnet",`https://api.etherscan.io/api?apikey=${i("ETHERSCAN_API_KEY")}`],["polygon",`https://api.polygonscan.com/api?apikey=${i("POLYGONSCAN_API_KEY")}`],["polygon-testnet",`https://api-testnet.polygonscan.com/api?apikey=${i("POLYGONSCAN_API_KEY")}`]]);var re=x.default.promisify(require("child_process").exec);async function oe(t,e,n){var u;let s=g.default.join(__dirname,"../contracts");(0,w.existsSync)(s)||(0,w.mkdirSync)(s);let o=t+"-"+(0,j.getAddress)(e);await(0,_.writeFile)(g.default.join(s,o+".sol"),n);let r=`slither ${g.default.join(s,o+".sol")} --json ${g.default.join(s,o+".json")} --exclude-low --exclude-medium --exclude-informational --exclude-optimization --solc-disable-warnings`;try{let{stdout:c,stderr:d}=await re(r)}catch{}let a=await(0,_.readFile)(g.default.join(s,o+".json"),{encoding:"utf8"}),l=JSON.parse(a.toString());return l.success===!0&&((u=l.results)==null?void 0:u.detectors)!=null&&l.results.detectors.length>0?(console.log("storeAndRun/foundIssue"),{foundIssue:!0,data:l.results.detectors}):(console.log("storeAndRun/Nothing Found"),{foundIssue:!1,data:[]})}f(oe,"storeAndRun");async function T(t,e){var o;let n=t+"-"+(0,j.getAddress)(e),s=g.default.join(__dirname,"../contracts",n+".json");if((0,w.existsSync)(s)){let r=await(0,_.readFile)(s,{encoding:"utf8"}),a=JSON.parse(r.toString());return a.success===!0&&((o=a.results)==null?void 0:o.detectors)!=null&&a.results.detectors.length>0?{cached:!0,success:!0,results:a.results.detectors,error:""}:{cached:!0,success:!0,results:[],error:""}}else{let r=await(0,M.default)(`${b.get(t)}&module=contract&action=getsourcecode&address=${e}`);if(r.ok===!0){let a=await r.json();if(a.status=="1"&&a.result.length>0)if(a.result[0].Proxy==="0"){let l=a.result[0].SourceCode,u=a.result[0].CompilerVersion.split("+")[0].slice(1),c=await I(u);if(console.log("setVersionResp",u,c),c===!0){let d=await oe(t,e,l);return d.foundIssue?{success:!0,results:d.data,error:""}:{success:!0,results:[],error:""}}else return console.log("Failed to set Solidity Version."),{success:!1,error:"Failed to set Solidity Version.",results:[]}}else return{success:!1,error:"Proxy",results:[]};else return console.log("Source code not verified on EtherScan"),{success:!1,error:"Source code not verified on EtherScan",results:[]}}else return console.log("Error Fetching Source Code from EtherScan"),{success:!1,error:"Error Fetching Source Code from EtherScan",results:[]}}}f(T,"testUsingSlither");var R=m(require("path")),L=m(require("util")),E=require("fs/promises"),k=require("fs"),F=require("@ethersproject/address"),U=m(require("cross-fetch"));var ne=L.default.promisify(require("child_process").exec);async function ie(t,e,n){let s=R.default.join(__dirname,"../contracts");(0,k.existsSync)(s)||(0,k.mkdirSync)(s);let o=t+"-"+(0,F.getAddress)(e);await(0,E.writeFile)(R.default.join(s,o+".sol"),n);let r=`myth analyze ${R.default.join(s,o+".sol")} -o json --execution-timeout 60 --max-depth 10 --parallel-solving --no-onchain-data > ${R.default.join(s,"mythril-"+o+".json")}`;try{let{stdout:u,stderr:c}=await ne(r)}catch{}let a=await(0,E.readFile)(R.default.join(s,"mythril-"+o+".json"),{encoding:"utf8"}),l=JSON.parse(a.toString());return(l==null?void 0:l.issues)!=null&&l.issues.length>0?(console.log("mythril/storeAndRun/foundIssue"),{foundIssue:!0,data:l.issues}):(console.log("mythril/storeAndRun/Nothing Found"),{foundIssue:!1,data:[]})}f(ie,"storeAndRun");async function O(t,e){let n=t+"-"+(0,F.getAddress)(e),s=R.default.join(__dirname,"../contracts","mythril-"+n+".json");if((0,k.existsSync)(s)){let o=await(0,E.readFile)(s,{encoding:"utf8"}),r=JSON.parse(o.toString());return(r==null?void 0:r.issues)!=null&&r.issues.length>0?{cached:!0,success:!0,results:r.issues,error:""}:{cached:!0,success:!0,results:[],error:""}}else{let o=await(0,U.default)(`${b.get(t)}&module=contract&action=getsourcecode&address=${e}`);if(o.ok===!0){let r=await o.json();if(r.status=="1"&&r.result.length>0)if(r.result[0].Proxy==="0"){let a=r.result[0].SourceCode,l=r.result[0].CompilerVersion.split("+")[0].slice(1),u=await I(l);if(console.log("setVersionResp",l,u),u===!0){let c=await ie(t,e,a);return c.foundIssue?{success:!0,results:c.data,error:""}:{success:!0,results:[],error:""}}else return console.log("Failed to set Solidity Version."),{success:!1,error:"Failed to set Solidity Version.",results:[]}}else return{success:!1,error:"Proxy",results:[]};else return console.log("Source code not verified on EtherScan"),{success:!1,error:"Source code not verified on EtherScan",results:[]}}else return console.log("Error Fetching Source Code from EtherScan"),{success:!1,error:"Error Fetching Source Code from EtherScan",results:[]}}}f(O,"testUsingMythril");var h=(0,$.default)({logger:!1}),ae=require("ethereumjs-util").toBuffer,ce=require("eth-phishing-detect");h.register(q.default,{global:!0});h.register(Y.default,{global:!0});h.register(K.default,{origin:"*"});var le=`https://api.tenderly.co/api/v1/account/${i("TENDERLY_USER")}/project/${i("TENDERLY_PROJECT")}/simulate`,ue=new G.Convo(i("CONVO_API_KEY")),de={alchemyApiKey:i("ALCHEMY_API_KEY"),CNVSEC_ID:i("CNVSEC_ID"),etherscanApiKey:i("ETHERSCAN_API_KEY"),polygonscanApiKey:i("POLYGONSCAN_API_KEY"),optimismscanApiKey:i("OPTIMISMSCAN_API_KEY"),polygonMainnetRpc:"",etherumMainnetRpc:"",avalancheMainnetRpc:"",maticPriceInUsd:0,etherumPriceInUsd:0,deepdaoApiKey:"",zapperApiKey:"",DEBUG:!1},P={mainnet:i("MAINNET_RPC_URL"),"mainnet-flashbots":i("MAINNET_FLASHBOTS_RPC_URL"),"mainnet-flashbots-fast":i("MAINNET_FLASHBOTS_FAST_RPC_URL"),ropsten:i("ROPSTEN_RPC_URL"),kovan:i("KOVAN_RPC_URL"),rinkeby:i("RINKEBY_RPC_URL"),goerli:i("GOERLI_RPC_URL"),sepolia:i("SEPOLIA_RPC_URL"),"goerli-flashbots":i("GOERLI_FLASHBOTS_RPC_URL"),polygon:i("POLYGON_RPC_URL"),"polygon-testnet":i("POLYGON_TESTNET_RPC_URL"),optimism:i("OPTIMISM_RPC_URL"),"optimism-testnet":i("OPTIMISM_TESTNET_RPC_URL"),arbitrum:i("ARBITRUM_RPC_URL"),"arbitrum-testnet":i("ARBITRUM_TESTNET_RPC_URL"),manual:"1"};Object.freeze(P);function p(t){return{isMalicious:!0,rpcResp:{id:420,jsonrpc:"2.0",error:{code:-32003,message:t}}}}f(p,"getMalRpcError");async function V(t){try{if((0,S.isAddress)(t)){let e=await ue.omnid.kits.isMalicious((0,S.getAddress)(t),de);return console.log("omnid.kits.isMalicious",(0,S.getAddress)(t),e),(e==null?void 0:e.alchemy)&&e.alchemy===!0?p("Spam Contract Flagged by Alchemy"):(e==null?void 0:e.chainabuse)&&e.chainabuse===!0?p("Contract Flagged by ChainAbuse"):(e==null?void 0:e.cryptoscamdb)&&e.cryptoscamdb===!0?p("Contract Flagged by CryptoscamDB"):(e==null?void 0:e.etherscan)&&"label"in e.etherscan?p(`Address Flagged as ${e.etherscan.label} by Etherscan`):(e==null?void 0:e.mew)&&"comment"in e.mew?p("Address Flagged by MyEtherWallet"):e!=null&&e.sdn?p("Address Flagged by OFAC"):e!=null&&e.tokenblacklist?p("Address Blacklisted by Stablecoin"):e!=null&&e.txn?p("Address/Contract Funded by Tornado Cash."):{isMalicious:!1}}else return{isMalicious:!1}}catch{return{isMalicious:!1}}}f(V,"checkAddress");async function fe(t){try{return await(0,C.default)(le,{method:"POST",body:JSON.stringify(t),headers:{"X-Access-Key":i("TENDERLY_ACCESS_KEY")}}).then(n=>n.json())}catch(e){return console.log("alchemySimulate",e),!1}}f(fe,"alchemySimulate");async function H(t,e){let n=e.query;try{let s=t==="manual"?n.rpcUrl:P[t];if(s!==void 0)return await(0,C.default)(s,{method:"POST",body:JSON.stringify(e.body),headers:{"Content-Type":"application/json",Accept:"application/json","infura-source":"metamask/internal",origin:"chrome-extension://nkbihfbeogaeaoehlefnkodbefgpgknn"}}).then(r=>r.json());{let{rpcResp:o}=p("Invalid RPC Url");return o}}catch(s){let{rpcResp:o}=p(s);return o}}f(H,"sendToRpc");async function pe(t,e){let n=e.body,s=e.query;var o=ae(n.params[0]),r=J.FeeMarketEIP1559Transaction.fromSerializedTx(o),a=r.toJSON();if(Object.keys(a).includes("to")===!0){let{isMalicious:c,rpcResp:d}=await V(a.to);if(c==!0&&d)return d.id=n.id,d}let l={network_id:parseInt(r.chainId.toString(10)),from:r.getSenderAddress().toString(),to:r.to?r.to.toString():"",input:r.data.toString("hex"),gas:parseInt(r.gasLimit.toString(10)),gas_price:r.maxFeePerGas.add(r.maxPriorityFeePerGas).toString(10),value:parseInt(r.value.toString(10)),save_if_fails:!0,save:!1,simulation_type:"full"},u=await fe(l);if(u!=null&&u!=!1&&"transaction_info"in u&&u.transaction_info!=null){console.log("Sim Successful");for(let c=0;c<u.transaction_info.logs.length;c++){let d=u.transaction_info.logs[c];if(d.name==="Approval"||d.name==="Transfer"){let{isMalicious:y,rpcResp:A}=await V(d.inputs[1].value);if(y===!0)return A}}}if(t!="manual"&&"blockUnverifiedContracts"in s&&s.blockUnverifiedContracts===!0){let c=await(0,C.default)(`https://sourcify.dev/server/check-all-by-addresses?addresses=${a==null?void 0:a.to}&chainIds=1,4,11155111,137,80001,10,42161,421611`),d;if(c.ok===!0){if(d=await c.json(),Object.keys(d).includes("status")){let{rpcResp:y}=p("The contract is unverified");return y}}else{let{rpcResp:y}=p("Sourcify Request Failed");return y}}if(t in["mainnet","polygon","polygon-testnet"]&&(s==null?void 0:s.enableScanners)!==void 0&&a.to!==void 0){let c=t,d=s.enableScanners.split(",");for(let y=0;y<d.length;y++){let A=d[y];if(A==="slither"){if((await T(c,a.to)).results.length>0)return p("Slither detected possible attack vectors")}else if(A==="mythril"&&(await O(c,a.to)).results.length>0)return p("Slither detected possible attack vectors")}}return await H(t,e)}f(pe,"processTxs");h.get("/",async(t,e)=>{let n=await(0,D.readFileSync)(B.default.join(__dirname,"../public/","index.html"));e.header("Content-Security-Policy","default-src *; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; img-src data:;"),e.type("text/html").send(n)});h.post("/lifejacket/slither",async(t,e)=>{let{network:n,address:s}=t.body;if(n!=null&&s!=null&&(0,S.isAddress)(s)){let o=await T(n,s);return e.send(o)}else return e.send({success:!1,error:"Invalid body params, network or address"})});h.post("/lifejacket/mythril",async(t,e)=>{let{network:n,address:s}=t.body;if(n!=null&&s!=null&&(0,S.isAddress)(s)){let o=await O(n,s);return e.send(o)}else return e.send({success:!1,error:"Invalid body params, network or address"})});h.post("/:network",async(t,e)=>{let{hostname:n}=t,s=t.body;if(ce(n)){let{rpcResp:r}=p(`\u{1F6A8} Phishing detector for the site ${n} has been triggered.`);e.send(r)}else{let{network:r}=t.params;if(r&&Object.keys(P).includes(r)===!0)if(s.method=="eth_sendRawTransaction"){let a=await pe(r,t);e.send(a)}else{let a=await H(r,t);e.send(a)}else e.send({error:`Invalid network '${r}', available networks are ${Object.keys(P).join(", ")}`})}});h.listen({port:parseInt(i("PORT"))||8545,host:"0.0.0.0"},(t,e)=>{if(!t)console.log("\u{1F680} Server is listening on",e);else throw t});
